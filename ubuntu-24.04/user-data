#cloud-config
#
# Ubuntu autoinstall profile for development VMs
# Target release: Ubuntu 24.04 LTS Server
# Last validated: 24.04.3 server installer ISO
#
# Design goals:
# - Reproducible base image
# - Desktop tools available, not auto-started
# - Predictable package versions (no unattended upgrades)
#

autoinstall:
  version: 1
  identity:
    hostname: ubuntu2404server
    username: sysadmin
    password: "$6$CHANGEME$QqHVx3DHLTZ1O.oelrIM/izmcW.2tuaHNiT0U30w.7kKn2EAuBjGW3QOPk.R2wkAT660r5xMtpSCEY675z6FZ/"
    realname: Default System Administrator
  locale: en_US.UTF-8
  keyboard:
    layout: us
    variant: ""
  ssh:
    install-server: true
    allow-pw: true
  storage:
    layout:
      name: lvm
  packages:
    - ubuntu-desktop
    - build-essential
    - linux-tools-generic
    - keychain
    - clang
    - llvm
    - libbpf-dev
    - python3.12-venv
    - perl
    - bzip2
    - tar
    - git
    
  user-data:
    chpasswd:
      list: |
        sysadmin:$6$CHANGEME$QqHVx3DHLTZ1O.oelrIM/izmcW.2tuaHNiT0U30w.7kKn2EAuBjGW3QOPk.R2wkAT660r5xMtpSCEY675z6FZ/
      expire: true
    
  late-commands:
    # Disable ssh until the default password has been changed
    - curtin in-target --target=/target -- systemctl disable ssh.service
    # Boot into non-graphical mode by default
    - curtin in-target --target=/target -- systemctl disable gdm3.service
    - curtin in-target --target=/target -- systemctl set-default multi-user.target
    # Disable automatic apt updates
    - curtin in-target --target=/target -- systemctl mask \
        apt-daily.service \
        apt-daily.timer \
        apt-daily-upgrade.service \
        apt-daily-upgrade.timer
    # Disable automatic PackageKit / GNOME updates
    - curtin in-target --target=/target -- systemctl mask \
        packagekit.service \
        packagekit-offline-update.service
    # Disable automatic snapd updates
    - curtin in-target --target=/target -- systemctl disable snapd.service snapd.socket
    - curtin in-target --target=/target -- systemctl mask snapd.service snapd.socket
    # Disable automatic firmware updates
    - curtin in-target --target=/target -- systemctl disable fwupd.service
    - curtin in-target --target=/target -- systemctl mask fwupd.service
    # Update package index and upgrade to latest stable manually
    - curtin in-target --target=/target -- apt update
    # Disable screen lock and suspend
    - curtin in-target --target=/target -- mkdir -p /etc/dconf/db/local.d
    - curtin in-target --target=/target -- apt install -y dconf-cli
    - |
      curtin in-target --target=/target -- bash -c "cat << 'EOF' > /etc/dconf/db/local.d/00-power
      [org/gnome/desktop/session]
      idle-delay=uint32 0

      [org/gnome/desktop/screensaver]
      lock-enabled=false
      EOF"
    - curtin in-target --target=/target -- dconf update
    # Configure global git defaults
    - curtin in-target --target=/target -- git config --system init.defaultBranch main
    - curtin in-target --target=/target -- git config --system fetch.prune true
    # Wait for getty output to finish, which may occlude the login prompt
    - curtin in-target --target=/target -- mkdir -p /etc/systemd/system/getty@tty1.service.d
    - |
      curtin in-target --target=/target -- bash -c "cat << 'EOF' > /etc/systemd/system/getty@tty1.service.d/override.conf
      [Unit]
      After=cloud-init-final.service
      Wants=cloud-init-final.service

      [Service]
      ExecStartPre=/usr/bin/test -f /run/cloud-init/result.json
      EOF"
    - curtin in-target --target=/target -- systemctl daemon-reload
    # Emit instructions during first login
    - curtin in-target --target=/target -- mkdir -p /etc/profile.d
    - |
      curtin in-target --target=/target -- bash -c "cat << 'EOF' > /etc/profile.d/first-login-msg.sh
      #!/bin/sh
      cat << 'MSG'

      Welcome! This system was installed using a default sysadmin account.
      Please create your own user before starting work.

          1. Create a user account:
              sudo adduser <newuser>

          2. Add the user to the 'sudo' group for administrative privileges:
              sudo usermod -aG sudo <newuser>

          3. Verify the changes:
              id <newuser>
              groups <newuser>
            ... should include your new username, and the group 'sudo'

          4. Enable and start the ssh server:
              sudo systemctl enable --now ssh.service

      After completing these steps, you can remove this message by running:
          sudo rm /etc/profile.d/first-login-msg.sh

      MSG
      EOF"