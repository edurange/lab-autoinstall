#cloud-config
#
# Ubuntu autoinstall profile for development VMs
# Target release: Ubuntu 24.04 LTS Server
# Last validated: 24.04.3 server installer ISO
#
# Design goals:
# - Reproducible base image
# - Desktop tools available, not auto-started
# - Predictable package versions (no unattended upgrades)
#

autoinstall:
  version: 1
  identity:
    hostname: ubuntu2404server
    username: sysadmin
    password: "$6$CHANGEME$QqHVx3DHLTZ1O.oelrIM/izmcW.2tuaHNiT0U30w.7kKn2EAuBjGW3QOPk.R2wkAT660r5xMtpSCEY675z6FZ/"
    realname: Default System Administrator
  locale: en_US.UTF-8
  keyboard:
    layout: us
    variant: ""
  ssh:
    install-server: true
    allow-pw: true
  storage:
    layout:
      name: lvm
  packages:
    - ubuntu-desktop
    - build-essential
    - linux-tools-generic
    - keychain
    - clang
    - llvm
    - libbpf-dev
    - python3.12-venv
    - perl
    - bzip2
    - tar
    - git
    
  user-data:
    chpasswd:
      list: |
        sysadmin:$6$CHANGEME$QqHVx3DHLTZ1O.oelrIM/izmcW.2tuaHNiT0U30w.7kKn2EAuBjGW3QOPk.R2wkAT660r5xMtpSCEY675z6FZ/
      expire: true
    
  late-commands:
    # Mount the autoinstall ISO to /cidata for easy access
    - mkdir -p /run/cidata
    - mount $(blkid -L cidata) /run/cidata
    # Disable ssh until the default password has been changed
    - curtin in-target --target=/target -- systemctl disable ssh.service
    # Boot into non-graphical mode by default
    - curtin in-target --target=/target -- systemctl disable gdm3.service
    - curtin in-target --target=/target -- systemctl set-default multi-user.target
    # Disable automatic apt updates
    - curtin in-target --target=/target -- systemctl mask \
        apt-daily.service \
        apt-daily.timer \
        apt-daily-upgrade.service \
        apt-daily-upgrade.timer
    # Disable automatic PackageKit / GNOME updates
    - curtin in-target --target=/target -- systemctl mask \
        packagekit.service \
        packagekit-offline-update.service
    # Disable automatic snapd updates
    - curtin in-target --target=/target -- systemctl disable snapd.service snapd.socket
    - curtin in-target --target=/target -- systemctl mask snapd.service snapd.socket
    # Disable automatic firmware updates
    - curtin in-target --target=/target -- systemctl disable fwupd.service
    - curtin in-target --target=/target -- systemctl mask fwupd.service
    # Update package index and upgrade to latest stable manually
    - curtin in-target --target=/target -- apt update
    # Disable screen lock and suspend
    - curtin in-target --target=/target -- apt install -y dconf-cli
    - install -D /run/cidata/assets/00-power /target/etc/dconf/db/local.d/00-power
    - curtin in-target --target=/target -- dconf update
    # Configure global git defaults
    - curtin in-target --target=/target -- git config --system init.defaultBranch main
    - curtin in-target --target=/target -- git config --system fetch.prune true
    # Wait for getty to finish to avoid login prompt race with late services
    - install -D /run/cidata/assets/override.conf /target/etc/systemd/system/getty@tty1.service.d/override.conf
    - install -D /run/cidata/assets/cleanup-getty-override.sh /target/usr/local/sbin/cleanup-getty-override.sh
    - chmod +x /target/usr/local/sbin/cleanup-getty-override.sh
    - install -D /run/cidata/assets/cleanup-getty-override.service /target/etc/systemd/system/cleanup-getty-override.service
    - curtin in-target --target=/target -- systemctl enable cleanup-getty-override.service
    # Add script for regenerating identity details during imaging
    - install -D /run/cidata/assets/reset-identity.sh /target/usr/local/sbin/reset-identity.sh
    - chmod +x /target/usr/local/sbin/reset-identity.sh
    # Emit instructions during first login
    - mkdir -p /target/etc/profile.d
    - install -D /run/cidata/assets/first-login-msg.sh /target/etc/profile.d/first-login-msg.sh
    # Unmount autoinstall filesystem
    - umount /run/cidata
    # Remove autoinstall data so reset-identity.sh does not re-trigger it
    - rm -f /target/var/lib/cloud/seed/nocloud/user-data
    - rm -f /target/var/lib/cloud/seed/nocloud/meta-data