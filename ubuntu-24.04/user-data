#cloud-config
#
# Ubuntu autoinstall profile for development VMs
# Target release: Ubuntu 24.04 LTS
# Last validated: 24.04.3 installer ISO
#
# Design goals:
# - Reproducible base image
# - Desktop tools available, not auto-started
# - Predictable package versions (no unattended upgrades)
#

autoinstall:
  version: 1
  identity:
    hostname: ubuntu-24-04-3-desktop-base
    username: sysadmin
    password: "$6$CHANGEME$QqHVx3DHLTZ1O.oelrIM/izmcW.2tuaHNiT0U30w.7kKn2EAuBjGW3QOPk.R2wkAT660r5xMtpSCEY675z6FZ/"
    realname: Default System Administrator
  locale: en_US.UTF-8
  keyboard:
    layout: us
    variant: ""
  ssh:
    install-server: true
    allow-pw: true
  storage:
    layout:
      name: lvm
  packages:
    - ubuntu-desktop
    - build-essential
    - linux-tools-generic
    - keychain
    - clang
    - llvm
    - libbpf-dev
    - python3.12-venv
    - perl
    - bzip2
    - tar
    - git
    
  user-data:
    chpasswd:
      list: |
        sysadmin:$6$CHANGEME$QqHVx3DHLTZ1O.oelrIM/izmcW.2tuaHNiT0U30w.7kKn2EAuBjGW3QOPk.R2wkAT660r5xMtpSCEY675z6FZ/
      expire: true
    
  late-commands:
    # Boot into non-graphical mode by default
    - curtin in-target --target=/target -- systemctl disable gdm3.service
    - curtin in-target --target=/target -- systemctl set-default multi-user.target
    # Stop background apt execution
    - curtin in-target --target=/target -- ln -sf /dev/null /etc/systemd/system/apt-daily.timer
    - curtin in-target --target=/target -- ln -sf /dev/null /etc/systemd/system/apt-daily-upgrade.timer
    - curtin in-target --target=/target -- ln -sf /dev/null /etc/systemd/system/apt-daily.service
    - curtin in-target --target=/target -- ln -sf /dev/null /etc/systemd/system/apt-daily.service
    - curtin in-target --target=/target -- ln -sf /dev/null /etc/systemd/system/packagekit.service
    # Update package index and upgrade to latest stable manually
    - curtin in-target --target=/target -- apt update
    # Disable screen lock and suspend
    - curtin in-target --target=/target -- mkdir -p /etc/dconf/db/local.d
    - curtin in-target --target=/target -- apt install -y dconf-cli
    - |
      curtin in-target --target=/target -- bash -c "cat << 'EOF' > /etc/dconf/db/local.d/00-power
      [org/gnome/desktop/session]
      idle-delay=uint32 0

      [org/gnome/desktop/screensaver]
      lock-enabled=false
      EOF"
    - curtin in-target --target=/target -- dconf update
    # Configure global git defaults
    - curtin in-target --target=/target -- git config --system init.defaultBranch main
    - curtin in-target --target=/target -- git config --system fetch.prune true
    # Suppress late output from cloud-init, which may occlude the login prompt
    - |
      curtin in-target --target=/target -- bash -c "cat << 'EOF' > /etc/profile.d/00-clear-cloud-init.sh
      # Clear noisy cloud-init output after boot
      if command -v cloud-init >/dev/null 2>&1; then
          if cloud-init status --wait >/dev/null 2>&1; then
              clear
          fi
      fi
      EOF"
    - curtin in-target --target=/target -- systemctl disable cloud-init-status.service
    - curtin in-target --target=/target -- systemctl mask cloud-init-status.service
    # Emit instructions during first login
    - curtin in-target --target=/target -- mkdir -p /etc/profile.d
    - |
      curtin in-target --target=/target -- bash -c "cat << 'EOF' > /etc/profile.d/first-login-msg.sh
      #!/bin/sh
      cat << 'MSG'

      Welcome! This system was installed using a default sysadmin account.
      Please create your own user before starting work.

          1. Create a user account:
              sudo adduser <newuser>

          2. Add the user to the 'sudo' group for administrative privileges:
              sudo usermod -aG sudo <newuser>

          3. Verify the changes:
              id <newuser>
              groups <newuser>
            ... should include your new username, and the group 'sudo'

      After completing these steps, you can remove this message by running:
          sudo rm /etc/profile.d/first-login-msg.sh

      MSG
      EOF"