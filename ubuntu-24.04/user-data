#cloud-config
#
# Ubuntu autoinstall profile for development VMs
# Target release: Ubuntu 24.04 LTS
# Last validated: 24.04.3 installer ISO
#
# Design goals:
# - Reproducible base image
# - Desktop tools available, not auto-started
# - Predictable package versions (no unattended upgrades)
#

autoinstall:
  version: 1
  identity:
    hostname: ubuntu-24-04-3-desktop-base
    username: sysadmin
    password: "$6$CHANGEME$QqHVx3DHLTZ1O.oelrIM/izmcW.2tuaHNiT0U30w.7kKn2EAuBjGW3QOPk.R2wkAT660r5xMtpSCEY675z6FZ/"
    realname: Default System Administrator
  locale: en_US.UTF-8
  keyboard:
    layout: us
    variant: ""
  ssh:
    install-server: true
    allow-pw: true
  storage:
    layout:
      name: lvm
  packages:
    - ubuntu-desktop
    - build-essential
    - keychain
    - clang
    - llvm
    - bpftool
    - libbpf-dev
    - python3.12-venv
    - perl
    - bzip2
    - tar
    - git
  updates:
    security: true
  late-commands:
    # Boot into non-graphical mode by default
    - curtin in-target --target=/target -- systemctl set-default multi-user.target
    # Default password expires immediately
    - curtin in-target --target=/target -- chage -d 0 sysadmin
    # Stop background apt execution
    - curtin in-target --target=/target -- systemctl disable --now apt-daily.timer
    - curtin in-target --target=/target -- systemctl disable --now apt-daily-upgrade.timer
    - curtin in-target --target=/target -- systemctl mask apt-daily.service
    - curtin in-target --target=/target -- systemctl mask apt-daily-upgrade.service
    - curtin in-target --target=/target -- systemctl mask packagekit.service
    # Update package index and upgrade to latest stable manually
    - curtin in-target --target=/target -- apt update
    - curtin in-target --target=/target -- apt upgrade -y
    # Disable screen lock and suspend
    - curtin in-target --target=/target -- gsettings set org.gnome.desktop.session idle-delay 0
    - curtin in-target --target=/target -- gsettings set org.gnome.desktop.screensaver lock-enabled false
    # Configure global git defaults
    - curtin in-target --target=/target -- git config --system init.defaultBranch main
    - curtin in-target --target=/target -- git config --system fetch.prune true
    # Set MOTD
    - |
      curtin in-target --target=/target -- tee /etc/motd.d/10-first-login << 'EOF'
      Welcome! This system was installed using a default sysadmin account.
      Please create your own user before starting work.
      
          1. Create a user account:
              sudo adduser <newuser>
              
          2. Add the user to the 'sudo' group for administrative privileges:
              sudo usermod -aG sudo <newuser>
              
          3. Verify the changes:
              id <newuser>
              groups <newuser>
            ... should include your new username, and the group 'sudo'
            
      Then log out and log in as your own account.
      EOF
